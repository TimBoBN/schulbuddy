{% extends "base.html" %}

{% block title %}Statistiken - SchulBuddy{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>ðŸ“Š Lernstatistiken</h1>
                    <p class="text-muted">Dein Lernfortschritt im Ãœberblick</p>
                </div>
                <div>
                    <a href="{{ url_for('statistics.streaks') }}" class="btn btn-outline-warning">
                        <i class="fas fa-fire"></i> Streak-Ãœbersicht
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Gamification Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h3>{{ user.level }}</h3>
                    <p class="mb-0">Level</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h3>{{ user.total_points }}</h3>
                    <p class="mb-0">Punkte</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h3>{{ user.current_streak }}</h3>
                    <p class="mb-0">Aktuelle Serie</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h3>{{ user.longest_streak }}</h3>
                    <p class="mb-0">LÃ¤ngste Serie</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Basis-Statistiken -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h4>{{ total_tasks }}</h4>
                    <p class="text-muted mb-0">Aufgaben gesamt</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h4>{{ completed_tasks }}</h4>
                    <p class="text-muted mb-0">Erledigte Aufgaben</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h4>{{ total_grades }}</h4>
                    <p class="text-muted mb-0">Noten eingetragen</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AktivitÃ¤ts-Heatmap -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸ“… AktivitÃ¤ts-Heatmap (Letztes Jahr)</h5>
                </div>
                <div class="card-body">
                    <div class="yearly-heatmaps">
                        <div id="heatmap-container">
                            <!-- Wird durch JavaScript gefÃ¼llt -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WÃ¶chentliche AktivitÃ¤t und Schuljahr-Vergleich -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸ“ˆ WÃ¶chentliche AktivitÃ¤t</h5>
                </div>
                <div class="card-body">
                    <canvas id="weeklyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸ“Š Schuljahr-Vergleich</h5>
                </div>
                <div class="card-body">
                    <canvas id="schoolYearChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Notenentwicklung pro Fach -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸ“ˆ Notenentwicklung pro Fach</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="gradeSubjectSelect" class="form-label">Fach auswÃ¤hlen:</label>
                            <select id="gradeSubjectSelect" class="form-select">
                                <option value="">Alle FÃ¤cher (max. 3)</option>
                                {% for subject in grade_progression_data.keys() %}
                                    <option value="{{ subject }}">{{ subject }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="alert alert-info mb-0">
                                <small>
                                    <i class="fas fa-info-circle"></i> 
                                    WÃ¤hle ein einzelnes Fach fÃ¼r beste Ãœbersicht oder zeige maximal 3 FÃ¤cher gleichzeitig an.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="position: relative; height: 450px;">
                        <canvas id="gradeProgressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fach-Performance -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸŽ¯ Fach-Performance</h5>
                </div>
                <div class="card-body">
                    {% if subject_performance %}
                        {% for subject, data in subject_performance.items() %}
                            <div class="mb-4 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span class="fw-bold">{{ subject }}</span>
                                        <br>
                                        <small class="text-muted">
                                            {{ data.normal_count }} normale Noten, 
                                            {{ data.certificate_count }} Zeugnisnoten
                                        </small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-{{ 'success' if data.average <= 2 else 'warning' if data.average <= 4 else 'danger' }} me-2">âŒ€ {{ data.average }}</span>
                                        {% if data.trend == 'improving' %}
                                            <i class="fas fa-arrow-up text-success" title="Verbesserung"></i>
                                        {% elif data.trend == 'declining' %}
                                            <i class="fas fa-arrow-down text-danger" title="Verschlechterung"></i>
                                        {% else %}
                                            <i class="fas fa-minus text-muted" title="Stabil"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Noch keine Noten vorhanden</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸ“Š Jahres-Durchschnitte</h5>
                </div>
                <div class="card-body">
                    {% if school_year_comparison %}
                        {% for year, data in school_year_comparison.items() %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ year }}</span>
                                <div>
                                    <span class="badge bg-{{ 'success' if data.average <= 2 else 'warning' if data.average <= 4 else 'danger' }}">{{ data.average }}</span>
                                    <small class="text-muted ms-1">({{ data.count }} Noten)</small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Noch keine Noten vorhanden</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Schnellaktionen -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ðŸš€ Schnellaktionen</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{{ url_for('statistics.achievements') }}" class="btn btn-primary btn-block mb-2">
                                <i class="fas fa-trophy me-1"></i> Achievements
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('statistics.notifications') }}" class="btn btn-info btn-block mb-2">
                                <i class="fas fa-bell me-1"></i> Benachrichtigungen
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('statistics.export_data') }}" class="btn btn-success btn-block mb-2">
                                <i class="fas fa-download me-1"></i> Daten exportieren
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-block mb-2">
                                <i class="fas fa-home me-1"></i> ZurÃ¼ck zum Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
// Heatmap-Daten
const activityData = {{ activity_data | tojson }};
const weeklyStats = {{ weekly_stats | tojson }};
const gradeProgressionData = {{ grade_progression_data | tojson }};
const schoolYearComparison = {{ school_year_comparison | tojson }};

console.log('ActivityData received:', activityData);
console.log('Grade progression data:', gradeProgressionData);
console.log('School year comparison:', schoolYearComparison);
console.log('Today:', new Date().toISOString().split('T')[0]);

// Jahresweise Heatmaps erstellen (wie GitHub)
function createYearlyHeatmaps() {
    const heatmapContainer = document.getElementById('heatmap-container');
    if (!heatmapContainer) {
        console.error('Heatmap container not found');
        return;
    }
    
    // Bestimme verfÃ¼gbare Jahre basierend auf AktivitÃ¤tsdaten
    const availableYears = new Set();
    Object.keys(activityData).forEach(dateStr => {
        const year = new Date(dateStr).getFullYear();
        availableYears.add(year);
    });
    
    // FÃ¼ge aktuelles Jahr hinzu, auch wenn keine Daten vorhanden
    const currentYear = new Date().getFullYear();
    availableYears.add(currentYear);
    
    // Sortiere Jahre absteigend (neueste zuerst)
    const sortedYears = Array.from(availableYears).sort().reverse();
    
    console.log('Creating heatmaps for years:', sortedYears);
    
    let html = '';
    
    sortedYears.forEach(year => {
        html += `
            <div class="year-heatmap mb-4">
                <h6 class="year-title">${year}</h6>
                <div class="heatmap-wrapper">
                    <div class="months-labels">
                        <span>Jan</span><span>Feb</span><span>MÃ¤r</span><span>Apr</span>
                        <span>Mai</span><span>Jun</span><span>Jul</span><span>Aug</span>
                        <span>Sep</span><span>Okt</span><span>Nov</span><span>Dez</span>
                    </div>
                    <div class="heatmap-grid" id="heatmap-${year}">
                        <!-- Wird durch JavaScript gefÃ¼llt -->
                    </div>
                </div>
            </div>
        `;
    });
    
    // Legende hinzufÃ¼gen
    html += `
        <div class="heatmap-legend">
            <span class="legend-text">Weniger</span>
            <div class="legend-scale">
                <div class="legend-item" data-level="0"></div>
                <div class="legend-item" data-level="1"></div>
                <div class="legend-item" data-level="2"></div>
                <div class="legend-item" data-level="3"></div>
                <div class="legend-item" data-level="4"></div>
            </div>
            <span class="legend-text">Mehr</span>
        </div>
    `;
    
    heatmapContainer.innerHTML = html;
    
    // Erstelle Heatmap fÃ¼r jedes Jahr
    sortedYears.forEach(year => {
        createYearHeatmap(year);
    });
}

function createYearHeatmap(year) {
    const heatmapGrid = document.getElementById(`heatmap-${year}`);
    if (!heatmapGrid) return;
    
    // Bestimme ob Schaltjahr
    const isLeapYear = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    const daysInYear = isLeapYear ? 366 : 365;
    
    // Erstelle Datum fÃ¼r 1. Januar des Jahres
    const startDate = new Date(year, 0, 1);
    
    // Bestimme Wochentag des ersten Tages (0 = Sonntag, 1 = Montag, etc.)
    const firstDayOfWeek = startDate.getDay();
    const adjustedFirstDay = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // Montag = 0
    
    // FÃ¼ge leere Tage am Anfang hinzu
    for (let i = 0; i < adjustedFirstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'heatmap-day empty';
        heatmapGrid.appendChild(emptyDay);
    }
    
    // Erstelle alle Tage des Jahres
    for (let dayOfYear = 0; dayOfYear < daysInYear; dayOfYear++) {
        const currentDate = new Date(year, 0, 1 + dayOfYear);
        const dateStr = currentDate.toISOString().split('T')[0];
        
        const dayElement = document.createElement('div');
        dayElement.className = 'heatmap-day';
        
        const count = activityData[dateStr] || 0;
        let level = 0;
        if (count > 0) level = 1;
        if (count > 2) level = 2;
        if (count > 4) level = 3;
        if (count > 6) level = 4;
        
        dayElement.setAttribute('data-level', level);
        dayElement.title = `${currentDate.toLocaleDateString('de-DE', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        })}: ${count} AktivitÃ¤ten`;
        
        heatmapGrid.appendChild(dayElement);
    }
    
    console.log(`Heatmap fÃ¼r ${year} erstellt (${daysInYear} Tage)`);
}

// WÃ¶chentliches Chart
function createWeeklyChart() {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    const labels = [];
    const taskData = [];
    const gradeData = [];
    
    for (const [week, data] of Object.entries(weeklyStats)) {
        labels.push(data.week_start);
        taskData.push(data.tasks);
        gradeData.push(data.grades);
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.reverse(),
            datasets: [{
                label: 'Aufgaben erledigt',
                data: taskData.reverse(),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }, {
                label: 'Noten eingetragen',
                data: gradeData.reverse(),
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Schuljahr-Vergleichsgraph
function createSchoolYearChart() {
    const ctx = document.getElementById('schoolYearChart');
    if (!ctx || !schoolYearComparison) return;
    
    const years = Object.keys(schoolYearComparison).sort();
    const averages = years.map(year => schoolYearComparison[year].average);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'Durchschnitt',
                data: averages,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false,
                    min: 1,
                    max: 6,
                    reverse: true, // Bessere Noten (niedrigere Zahlen) oben
                    title: {
                        display: true,
                        text: 'Notendurchschnitt'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Schuljahr'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Notendurchschnitt pro Schuljahr'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Durchschnitt: ${context.parsed.y}`;
                        }
                    }
                }
            }
        }
    });
}

// Notenentwicklung pro Fach - OPTIMIERTE VERSION
let gradeProgressChart = null;

function createGradeProgressChart(selectedSubject = '') {
    const canvas = document.getElementById('gradeProgressChart');
    if (!canvas) {
        console.error('Canvas element nicht gefunden');
        return;
    }
    
    console.log('Erstelle Notenentwicklungs-Chart fÃ¼r:', selectedSubject || 'alle FÃ¤cher (max 3)');
    console.log('VerfÃ¼gbare Daten:', gradeProgressionData);
    
    // Vorherigen Chart zerstÃ¶ren
    if (gradeProgressChart) {
        gradeProgressChart.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    
    // Bestimme welche FÃ¤cher angezeigt werden sollen
    let subjectsToShow;
    if (selectedSubject && selectedSubject !== '') {
        subjectsToShow = [selectedSubject];
    } else {
        // Zeige nur die ersten 3 FÃ¤cher mit Daten fÃ¼r bessere Ãœbersicht
        const availableSubjects = Object.keys(gradeProgressionData).filter(subject => 
            gradeProgressionData[subject] && gradeProgressionData[subject].grades.length > 0
        );
        subjectsToShow = availableSubjects.slice(0, 3);
    }
    
    console.log('Zeige FÃ¤cher:', subjectsToShow);
    
    if (subjectsToShow.length === 0) {
        console.warn('Keine FÃ¤cher zu zeigen');
        return;
    }
    
    const datasets = [];
    const colors = [
        '#FF6B6B', // Rot
        '#4ECDC4', // TÃ¼rkis  
        '#45B7D1', // Blau
        '#96CEB4', // GrÃ¼n
        '#FFEAA7', // Gelb
        '#DDA0DD', // Lila
        '#98D8C8', // Mint
        '#F7DC6F'  // Gold
    ];
    
    let allLabels = [];
    let colorIndex = 0;
    
    // Sammle alle Daten und erstelle einheitliche Labels
    subjectsToShow.forEach(subject => {
        if (gradeProgressionData[subject] && gradeProgressionData[subject].grades.length > 0) {
            const subjectData = gradeProgressionData[subject];
            
            // FÃ¼ge Labels hinzu falls noch nicht vorhanden
            subjectData.dates.forEach(dateStr => {
                const date = new Date(dateStr);
                const label = date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short' });
                if (!allLabels.includes(label)) {
                    allLabels.push(label);
                }
            });
        }
    });
    
    // Sortiere Labels chronologisch
    allLabels.sort((a, b) => {
        const dateA = new Date('2025 ' + a.replace('.', ' '));
        const dateB = new Date('2025 ' + b.replace('.', ' '));
        return dateA - dateB;
    });
    
    // Erstelle Datasets fÃ¼r jedes Fach
    subjectsToShow.forEach(subject => {
        if (gradeProgressionData[subject] && gradeProgressionData[subject].grades.length > 0) {
            const subjectData = gradeProgressionData[subject];
            
            console.log(`Daten fÃ¼r ${subject}:`, subjectData);
            
            // Erstelle Datenarray passend zu allLabels
            const chartData = allLabels.map(label => {
                // Finde passende Note fÃ¼r dieses Label
                const dateIndex = subjectData.dates.findIndex(dateStr => {
                    const date = new Date(dateStr);
                    const formattedDate = date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short' });
                    return formattedDate === label;
                });
                
                return dateIndex !== -1 ? subjectData.grades[dateIndex] : null;
            });
            
            datasets.push({
                label: subject,
                data: chartData,
                borderColor: colors[colorIndex % colors.length],
                backgroundColor: colors[colorIndex % colors.length] + '20',
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: colors[colorIndex % colors.length],
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.3,
                fill: false,
                spanGaps: true // Verbinde Punkte auch wenn Daten fehlen
            });
            
            colorIndex++;
        }
    });
    
    console.log('Alle Datasets:', datasets);
    console.log('Labels:', allLabels);
    
    if (datasets.length === 0) {
        console.warn('Keine Daten fÃ¼r Chart verfÃ¼gbar');
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Keine Daten verfÃ¼gbar', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // Erstelle den Chart
    gradeProgressChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: allLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 20,
                    right: 20,
                    bottom: 20,
                    left: 20
                }
            },
            scales: {
                y: {
                    min: 1,
                    max: 6,
                    reverse: true,
                    title: {
                        display: true,
                        text: 'Note',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        stepSize: 0.5,
                        callback: function(value) {
                            return value.toFixed(1);
                        },
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: '#e0e0e0'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Datum',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        maxRotation: 45
                    },
                    grid: {
                        color: '#f0f0f0'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: selectedSubject && selectedSubject !== '' 
                        ? `Notenentwicklung: ${selectedSubject}` 
                        : `Notenentwicklung (${subjectsToShow.join(', ')})`,
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    padding: 20
                },
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255,255,255,0.2)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y}`;
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    console.log('Chart erfolgreich erstellt');
}

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM geladen, starte Chart-Initialisierung');
    
    createYearlyHeatmaps();
    createWeeklyChart();
    createSchoolYearChart();
    
    // Notenentwicklungs-Chart erstellen
    setTimeout(() => {
        createGradeProgressChart();
    }, 150);
    
    // Event-Handler fÃ¼r Fach-Auswahl
    const subjectSelect = document.getElementById('gradeSubjectSelect');
    if (subjectSelect) {
        console.log('Subject select gefunden, fÃ¼ge Event-Listener hinzu');
        subjectSelect.addEventListener('change', function() {
            const selectedSubject = this.value;
            console.log('Fach ausgewÃ¤hlt:', selectedSubject);
            createGradeProgressChart(selectedSubject);
        });
    } else {
        console.error('Subject select element nicht gefunden');
    }
});
</script>

<style>
/* Jahresweise Heatmaps (GitHub-Style) */
.yearly-heatmaps {
    max-height: 600px;
    overflow-y: auto;
    padding: 1rem;
}

.year-heatmap {
    margin-bottom: 3rem;
}

.year-title {
    font-weight: bold;
    color: var(--bs-body-color);
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.heatmap-wrapper {
    position: relative;
    overflow-x: auto;
    padding-bottom: 1rem;
}

.months-labels {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 2px;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
    color: var(--bs-text-muted);
    text-align: center;
}

.heatmap-grid {
    display: grid;
    grid-template-columns: repeat(53, 1fr);
    grid-template-rows: repeat(7, 1fr);
    gap: 2px;
    grid-auto-flow: column;
    min-width: 600px;
}

.heatmap-day {
    width: 11px;
    height: 11px;
    border-radius: 2px;
    background-color: #ebedf0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.heatmap-day.empty {
    background-color: transparent;
    cursor: default;
}

.heatmap-day:hover:not(.empty) {
    outline: 2px solid var(--bs-primary);
    outline-offset: 1px;
}

.heatmap-day[data-level="1"] { background-color: #9be9a8; }
.heatmap-day[data-level="2"] { background-color: #40c463; }
.heatmap-day[data-level="3"] { background-color: #30a14e; }
.heatmap-day[data-level="4"] { background-color: #216e39; }

.heatmap-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
    font-size: 0.8rem;
    color: var(--bs-text-muted);
}

.legend-scale {
    display: flex;
    gap: 2px;
}

.legend-item {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    background-color: #ebedf0;
}

.legend-item[data-level="1"] { background-color: #9be9a8; }
.legend-item[data-level="2"] { background-color: #40c463; }
.legend-item[data-level="3"] { background-color: #30a14e; }
.legend-item[data-level="4"] { background-color: #216e39; }

.legend-text {
    font-size: 0.75rem;
}

/* Dark Mode Support */
[data-bs-theme="dark"] .heatmap-day {
    background-color: #161b22;
}

[data-bs-theme="dark"] .heatmap-day[data-level="1"] { background-color: #0e4429; }
[data-bs-theme="dark"] .heatmap-day[data-level="2"] { background-color: #006d32; }
[data-bs-theme="dark"] .heatmap-day[data-level="3"] { background-color: #26a641; }
[data-bs-theme="dark"] .heatmap-day[data-level="4"] { background-color: #39d353; }

[data-bs-theme="dark"] .legend-item {
    background-color: #161b22;
}

[data-bs-theme="dark"] .legend-item[data-level="1"] { background-color: #0e4429; }
[data-bs-theme="dark"] .legend-item[data-level="2"] { background-color: #006d32; }
[data-bs-theme="dark"] .legend-item[data-level="3"] { background-color: #26a641; }
[data-bs-theme="dark"] .legend-item[data-level="4"] { background-color: #39d353; }

[data-bs-theme="dark"] .heatmap-day:hover:not(.empty) {
    outline-color: var(--bs-primary);
}

/* Responsive Design */
@media (max-width: 768px) {
    .heatmap-wrapper {
        overflow-x: scroll;
    }
    
    .months-labels {
        min-width: 600px;
    }
    
    .heatmap-grid {
        min-width: 600px;
    }
}

/* Scrollbar Styling */
.yearly-heatmaps::-webkit-scrollbar {
    width: 8px;
}

.yearly-heatmaps::-webkit-scrollbar-track {
    background: var(--bs-body-bg);
}

.yearly-heatmaps::-webkit-scrollbar-thumb {
    background: var(--bs-border-color);
    border-radius: 4px;
}

.yearly-heatmaps::-webkit-scrollbar-thumb:hover {
    background: var(--bs-secondary);
}
</style>
{% endblock %}
